# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞ "–ì–¥–µ–ì—Ä—É–∑"

**–í–µ—Ä—Å–∏—è:** 2.0 (Phase 2 - Simplified Trip System)
**–î–∞—Ç–∞:** –ù–æ—è–±—Ä—å 2025
**–°—Ç–∞—Ç—É—Å:** Production Ready

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è](#–æ–±—â–∞—è-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
2. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
4. [–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏](#—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
5. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
6. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
7. [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω—é–∞–Ω—Å—ã](#–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-–Ω—é–∞–Ω—Å—ã)
8. [–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ](#—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)
9. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-—Ä–∞–∑–≤–∏—Ç–∏—é)

---

## –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

**–ì–¥–µ–ì—Ä—É–∑** - Telegram-–±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–æ–∫. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã –º–µ–∂–¥—É **–∫—É—Ä–∞—Ç–æ—Ä–∞–º–∏** (–¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞–º–∏) –∏ **–≤–æ–¥–∏—Ç–µ–ª—è–º–∏**.

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

- –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Å–∞–º–∏
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª–µ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ —Ä–µ–π—Å–æ–≤
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—ã Telegram
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª–µ–π –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞

### –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è

1. **–ö—É—Ä–∞—Ç–æ—Ä—ã (–¥–∏—Å–ø–µ—Ç—á–µ—Ä—ã)** - —Å–æ–∑–¥–∞—é—Ç –∏ —É–ø—Ä–∞–≤–ª—è—é—Ç —Ä–µ–π—Å–∞–º–∏, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π
2. **–í–æ–¥–∏—Ç–µ–ª–∏** - –ø–æ–ª—É—á–∞—é—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —Ä–µ–π—Å—ã, –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é, –æ–±–Ω–æ–≤–ª—è—é—Ç —Å—Ç–∞—Ç—É—Å—ã

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend

- **Python 3.11+**
- **Aiogram 3.x** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è Telegram Bot API
- **aiosqlite** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å SQLite
- **asyncio** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

- **SQLite** - –¥–≤–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
  - `points.db` - –≤–æ–¥–∏—Ç–µ–ª–∏, –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è
  - `trips.db` - —Ä–µ–π—Å—ã, —Å–æ–±—ã—Ç–∏—è

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

- **Docker & Docker Compose v1** (‚ö†Ô∏è –≤–∞–∂–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è docker-compose —Å –¥–µ—Ñ–∏—Å–æ–º, –Ω–µ –ø—Ä–æ–±–µ–ª–æ–º)
- **Ubuntu 22.04 LTS**
- **Git** –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **FastAPI** (`web.api`) - –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç—ã (–ø–æ—Ä—Ç 8000)
- **Uvicorn** - ASGI —Å–µ—Ä–≤–µ—Ä

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –û–±—â–∞—è —Å—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Telegram Bot API                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Aiogram 3 Dispatcher                  ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ          FSM (States)                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - RegistrationStates                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - CreateTripStates                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - EditTripStates                        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ         Routers/Handlers                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - start.py (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, —Ä–æ–ª–∏)         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - contact.py (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª–µ–π)   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - curator.py (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Å–∞–º–∏)      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - driver_trips.py (–≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ.)‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - location.py (–æ—Ç–ø—Ä–∞–≤–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏)    ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Database Layer (db.py, db_trips.py)     ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   points.db    ‚îÇ      ‚îÇ    trips.db      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                ‚îÇ      ‚îÇ                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - drivers     ‚îÇ      ‚îÇ  - trips         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - points      ‚îÇ      ‚îÇ  - trip_events   ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–º–æ–¥—É–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:

1. **Handlers** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **Database modules** - —Ä–∞–±–æ—Ç–∞ —Å –ë–î
3. **Keyboards** - –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –∫–Ω–æ–ø–∫–∏
4. **Background tasks** - —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è)

---

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –î–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π

#### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:** –í–æ–¥–∏—Ç–µ–ª—å –¥–µ–ª–∏—Ç—Å—è –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É
- **–ü—Ä–æ—Ü–µ—Å—Å:**
  1. –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ ‚Üí –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞
  2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ –ë–î
  3. –ï—Å–ª–∏ –Ω–æ–≤—ã–π ‚Üí –∑–∞–ø—Ä–æ—Å –∏–º–µ–Ω–∏ —á–µ—Ä–µ–∑ FSM
  4. –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ –∏–º–µ–Ω–∏
  5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Ä–µ–π—Å–æ–≤
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:** –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–æ **–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞** (+79991234567)

#### 2. –ú–æ–∏ —Ä–µ–π—Å—ã
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Ä–µ–π—Å–æ–≤ –ø–æ **–Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞** –≤–æ–¥–∏—Ç–µ–ª—è
- –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–π—Å–∞
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (–∞–∫—Ç–∏–≤–µ–Ω ‚Üí –ø–æ–≥—Ä—É–∑–∫–∞ ‚Üí –≤ –ø—É—Ç–∏ ‚Üí –≤—ã–≥—Ä—É–∑–∫–∞ ‚Üí –∑–∞–≤–µ—Ä—à–µ–Ω)
- –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π —Ä–µ–π—Å–∞

#### 3. –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
- **–ö–Ω–æ–ø–∫–∞ "üìç –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–µ—Å—Ç–æ–º"** - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è** –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `REMIND_HOURS`)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–æ—á–µ–∫ –≤ –ë–î

#### 4. –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- **–ö–Ω–æ–ø–∫–∞ "üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã"**
- –ü—Ä–∏–µ–º —Ñ–æ—Ç–æ –∏ PDF —Ñ–∞–π–ª–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –≤ –≥—Ä—É–ø–ø—ã –∫—É—Ä–∞—Ç–æ—Ä–æ–≤ —Å –ø–æ–¥–ø–∏—Å—å—é (–∏–º—è + —Ç–µ–ª–µ—Ñ–æ–Ω)

### –î–ª—è –∫—É—Ä–∞—Ç–æ—Ä–æ–≤

#### 1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Å–∞–º–∏

**–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–π—Å–∞:**
```
/create_trip –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "‚ûï –°–æ–∑–¥–∞—Ç—å —Ä–µ–π—Å"

–§–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞ (6 —Å—Ç—Ä–æ–∫):
+79991234567
–ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞ 1
–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –ø—Ä. –ù–µ–≤—Å–∫–∏–π 10
20.11
21.11
50000
```

- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ (–¢–õ-0001, –¢–õ-0002...)
- –ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–π—Å–∞:**
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∞–¥—Ä–µ—Å–æ–≤, –¥–∞—Ç, —Å—Ç–∞–≤–∫–∏
- FSM –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `trip_events`

**–ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–π—Å–∞:**
- –†—É—á–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –∫—É—Ä–∞—Ç–æ—Ä–æ–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—è

**–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–π—Å–∞:**
- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ **2 –≥—Ä—É–ø–ø—ã:**
  - –ì—Ä—É–ø–ø–∞ "–ö—É—Ä–∞—Ç–æ—Ä –†–µ–π—Å–∞" (ID: -1002606502231)
  - –ì—Ä—É–ø–ø–∞ "–ì–¥–µ–ì—Ä—É–∑ –î–æ–∫—É–º–µ–Ω—Ç—ã" (ID: -5054329274)
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–π—Å–µ

#### 2. –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–π—Å–æ–≤

**–§–∏–ª—å—Ç—Ä—ã:**
- –í—Å–µ —Ä–µ–π—Å—ã
- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–π—Å—ã (assigned, active, loading, in_transit, unloading)
- –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Ä–µ–π—Å—ã

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:**
- –ù–æ–º–µ—Ä —Ä–µ–π—Å–∞
- **–ò–º—è –≤–æ–¥–∏—Ç–µ–ª—è + —Ç–µ–ª–µ—Ñ–æ–Ω** (–µ—Å–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω)
- –ê–¥—Ä–µ—Å–∞ (—Å–æ–∫—Ä–∞—â–µ–Ω–Ω–æ)
- –°—Ç–∞—Ç—É—Å —Å emoji

#### 3. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ

- –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–π –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤–æ–¥–∏—Ç–µ–ª—è
- –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –ö–Ω–æ–ø–∫–∞ "üìç –ó–∞–ø—Ä–æ—Å–∏—Ç—å –º–µ—Å—Ç–æ" ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—é

#### 4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–π—Å–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
- –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ, –∞–∫—Ç–∏–≤–Ω—ã–µ, –≤ –ø–æ–≥—Ä—É–∑–∫–µ, –≤ –ø—É—Ç–∏, –≤ –≤—ã–≥—Ä—É–∑–∫–µ, –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –ë–∞–∑–∞ `points.db`

#### –¢–∞–±–ª–∏—Ü–∞ `drivers`

```sql
CREATE TABLE drivers (
    user_id INTEGER PRIMARY KEY,
    phone TEXT UNIQUE,
    name TEXT,                    -- –ò–º—è –≤–æ–¥–∏—Ç–µ–ª—è
    active INTEGER DEFAULT 1,     -- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
    registered_at TEXT            -- –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
);

CREATE INDEX idx_drivers_phone ON drivers(phone);
```

**–í–∞–∂–Ω–æ:** `phone` —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ: **+79991234567**

#### –¢–∞–±–ª–∏—Ü–∞ `points`

```sql
CREATE TABLE points (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    lat REAL NOT NULL,
    lon REAL NOT NULL,
    ts TEXT NOT NULL,             -- ISO timestamp
    FOREIGN KEY (user_id) REFERENCES drivers(user_id)
);

CREATE INDEX idx_points_user_ts ON points(user_id, ts DESC);
```

### –ë–∞–∑–∞ `trips.db`

#### –¢–∞–±–ª–∏—Ü–∞ `trips`

```sql
CREATE TABLE trips (
    trip_id INTEGER PRIMARY KEY AUTOINCREMENT,
    trip_number TEXT UNIQUE NOT NULL,  -- –¢–õ-0001, –¢–õ-0002...
    user_id INTEGER,                    -- Telegram ID (–º–æ–∂–µ—Ç –±—ã—Ç—å 0)
    phone TEXT NOT NULL,                -- –¢–µ–ª–µ—Ñ–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ +79991234567
    loading_address TEXT NOT NULL,
    loading_date TEXT NOT NULL,         -- –î–î.–ú–ú.–ì–ì–ì–ì
    unloading_address TEXT NOT NULL,
    unloading_date TEXT NOT NULL,       -- –î–î.–ú–ú.–ì–ì–ì–ì
    rate REAL NOT NULL,                 -- –°—Ç–∞–≤–∫–∞ –≤ —Ä—É–±–ª—è—Ö
    status TEXT DEFAULT 'assigned',
    created_at TEXT NOT NULL,
    loading_confirmed_at TEXT,
    unloading_confirmed_at TEXT,
    completed_at TEXT,
    curator_id INTEGER                  -- Telegram ID –∫—É—Ä–∞—Ç–æ—Ä–∞
);

CREATE INDEX idx_trips_phone ON trips(phone);
CREATE INDEX idx_trips_user ON trips(user_id);
CREATE INDEX idx_trips_status ON trips(status);
CREATE INDEX idx_trips_number ON trips(trip_number);
```

**–°—Ç–∞—Ç—É—Å—ã —Ä–µ–π—Å–∞:**
- `assigned` - –Ω–∞–∑–Ω–∞—á–µ–Ω, –æ–∂–∏–¥–∞–µ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
- `active` - –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤–æ–¥–∏—Ç–µ–ª–µ–º
- `loading` - –∏–¥–µ—Ç –ø–æ–≥—Ä—É–∑–∫–∞
- `in_transit` - –≤ –ø—É—Ç–∏
- `unloading` - –∏–¥–µ—Ç –≤—ã–≥—Ä—É–∑–∫–∞
- `completed` - –∑–∞–≤–µ—Ä—à–µ–Ω

#### –¢–∞–±–ª–∏—Ü–∞ `trip_events`

```sql
CREATE TABLE trip_events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    trip_id INTEGER NOT NULL,
    event_type TEXT NOT NULL,          -- created, status_changed, etc.
    description TEXT,
    created_at TEXT NOT NULL,
    created_by INTEGER,                -- user_id –∫—Ç–æ —Å–æ–∑–¥–∞–ª
    metadata TEXT,                     -- JSON
    FOREIGN KEY (trip_id) REFERENCES trips(trip_id)
);

CREATE INDEX idx_trip_events_trip ON trip_events(trip_id, created_at DESC);
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
GdeGruz/
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ start.py              # –°—Ç–∞—Ä—Ç–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contact.py            # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª–µ–π (FSM)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ curator.py            # –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫—É—Ä–∞—Ç–æ—Ä–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ driver_trips.py       # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Å–∞–º–∏ –≤–æ–¥–∏—Ç–µ–ª—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ location.py           # –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stop.py               # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ resume.py             # –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ keyboards.py              # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã (ReplyKeyboard)
‚îÇ   ‚îî‚îÄ‚îÄ main.py                   # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
‚îÇ
‚îú‚îÄ‚îÄ web/
‚îÇ   ‚îî‚îÄ‚îÄ api.py                    # FastAPI –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
‚îÇ
‚îú‚îÄ‚îÄ db.py                         # –†–∞–±–æ—Ç–∞ —Å points.db (–≤–æ–¥–∏—Ç–µ–ª–∏, —Ç–æ—á–∫–∏)
‚îú‚îÄ‚îÄ db_trips.py                   # –†–∞–±–æ—Ç–∞ —Å trips.db (—Ä–µ–π—Å—ã)
‚îÇ
‚îú‚îÄ‚îÄ Dockerfile                    # –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
‚îú‚îÄ‚îÄ docker-compose.yml            # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ requirements.txt              # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ
‚îú‚îÄ‚îÄ .env                          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–Ω–µ –≤ Git!)
‚îÇ   # BOT_TOKEN=...
‚îÇ   # CURATOR_IDS=123,456
‚îÇ   # GROUP_CHAT_ID=...
‚îÇ   # REMIND_HOURS=12
‚îÇ   # STAGE=bot
‚îÇ
‚îî‚îÄ‚îÄ migrate_normalize_phones.py  # –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–æ–≤
```

### –í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã

#### `db.py` - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:

```python
def normalize_phone(phone: str) -> str:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –Ω–æ–º–µ—Ä –∫ —Ñ–æ—Ä–º–∞—Ç—É +79991234567

    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç: +7, 7, 8, 9 (–±–µ–∑ –∫–æ–¥–∞)
    """

async def save_phone(user_id, phone, name=None):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—è"""

async def get_driver_by_phone(phone):
    """–ü–æ–∏—Å–∫ –≤–æ–¥–∏—Ç–µ–ª—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É"""

async def get_user_id_by_phone(phone):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ user_id –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É"""
```

#### `db_trips.py` - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:

```python
async def create_trip_by_curator(...):
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–π—Å–∞ –∫—É—Ä–∞—Ç–æ—Ä–æ–º"""

async def get_trips_by_phone(phone, status=None):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–π—Å–æ–≤ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –≤–æ–¥–∏—Ç–µ–ª—è"""

async def update_trip_status(trip_id, new_status, updated_by):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ–π—Å–∞"""
```

#### `bot/handlers/curator.py` - –•–µ–ª–ø–µ—Ä:

```python
async def get_driver_name_by_phone(phone: str) -> str:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –≤–æ–¥–∏—Ç–µ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö"""
```

---

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω—é–∞–Ω—Å—ã

### 1. ‚ö†Ô∏è –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤

**–ö–†–ê–ô–ù–ï –í–ê–ñ–ù–û:** –í—Å–µ –Ω–æ–º–µ—Ä–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∫ —Ñ–æ—Ä–º–∞—Ç—É `+79991234567`

**–ü—Ä–æ–±–ª–µ–º–∞:** Telegram –º–æ–∂–µ—Ç –æ—Ç–¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö:
- `79991234567`
- `89991234567`
- `+79991234567`
- `9991234567`

**–†–µ—à–µ–Ω–∏–µ:** –§—É–Ω–∫—Ü–∏—è `normalize_phone()` –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è:
- –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–æ–¥–∏—Ç–µ–ª—è
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–π—Å–∞
- –ü—Ä–∏ –ø–æ–∏—Å–∫–µ –≤ –ë–î

**–ú–∏–≥—Ä–∞—Ü–∏—è:** –°–∫—Ä–∏–ø—Ç `migrate_normalize_phones.py` –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏

### 2. ‚ö†Ô∏è –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª–µ–π

**–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –ù–ï –ø–æ user_id!**

**–ü–æ—á–µ–º—É:**
- –í–æ–¥–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–π—Å–∞
- –†–µ–π—Å –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –î–û —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–æ–¥–∏—Ç–µ–ª—è
- –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. **–ö—É—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç —Ä–µ–π—Å** —Å –Ω–æ–º–µ—Ä–æ–º `+79991234567`
   - –°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è —Å —ç—Ç–∏–º –Ω–æ–º–µ—Ä–æ–º
   - –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
   - –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å `user_id = 0`

2. **–í–æ–¥–∏—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è** —Å –Ω–æ–º–µ—Ä–æ–º `79991234567`
   - –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è ‚Üí `+79991234567`
   - –°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç —Ä–µ–π—Å—ã —Å —ç—Ç–∏–º –Ω–æ–º–µ—Ä–æ–º
   - –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ä–∞–∑—É
   - –û–±–Ω–æ–≤–ª—è–µ—Ç `user_id` –≤ —Ä–µ–π—Å–µ

**–í–∞–∂–Ω–æ –≤ –∫–æ–¥–µ:**
```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
trips = await db_trips.get_trips_by_phone(phone)

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ø–æ–∏—Å–∫ –ø–æ user_id
trips = await db_trips.get_user_active_trips(user_id)
```

### 3. ‚ö†Ô∏è FSM (Finite State Machine)

**Aiogram 3 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç FSM –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤:**
- `RegistrationStates.waiting_for_name` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª—è
- `CreateTripStates.waiting_data` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–π—Å–∞
- `EditTripStates.*` - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–µ–π —Ä–µ–π—Å–∞

**–í–∞–∂–Ω–æ:**
- `await state.set_state(...)` - –ø–µ—Ä–µ—Ö–æ–¥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- `await state.get_data()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- `await state.update_data(...)` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- `await state.clear()` - –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:**
```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
data = await state.get_data()
phone = data.get('phone')
await state.clear()  # –û—á–∏—Å—Ç–∏–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
# ... –ø–æ–∑–∂–µ
data = await state.get_data()  # –ü–æ–ª—É—á–∏–º –ø—É—Å—Ç–æ–π dict!
phone = data.get('phone')  # None!

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
data = await state.get_data()
phone = data.get('phone')
# –ò—Å–ø–æ–ª—å–∑—É–µ–º phone –ü–ï–†–ï–î –æ—á–∏—Å—Ç–∫–æ–π
await state.clear()
```

### 4. ‚ö†Ô∏è Docker & Docker Compose

**–ù–ê –°–ï–†–í–ï–†–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Docker Compose v1:**

```bash
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
docker-compose up -d
docker-compose logs
docker-compose restart bot

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (v2 —Å–∏–Ω—Ç–∞–∫—Å–∏—Å)
docker compose up -d
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω alias:
```bash
docker -> docker-compose  # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ!
```

**–†–µ—à–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–∞–Ω–¥:**
```bash
# –î–ª—è Docker –∫–æ–º–∞–Ω–¥ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å
/usr/bin/docker ps
/usr/bin/docker exec container_id python script.py

# –î–ª—è docker-compose –∫–æ–º–∞–Ω–¥ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ã—á–Ω—ã–π –≤—ã–∑–æ–≤
docker-compose up -d
```

**–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:**
```bash
# –ü–æ–ª—É—á–∏—Ç—å ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
BOT_ID=$(/usr/bin/docker ps | grep fleet-live-bot-bot | awk '{print $1}')

# –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
/usr/bin/docker exec -it $BOT_ID bash

# –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É
/usr/bin/docker exec $BOT_ID python /app/script.py
```

### 5. ‚ö†Ô∏è Parse Mode: HTML vs Markdown

**–ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø HTML, –ù–ï Markdown!**

**–ü—Ä–æ–±–ª–µ–º–∞ Markdown:**
- –ù–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ —Å–æ–¥–µ—Ä–∂–∞—Ç `_` (–ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)
- –ê–¥—Ä–µ—Å–∞ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å `*`, `_`, `[`, `]`
- Markdown –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –∏—Ö –∫–∞–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –û—à–∏–±–∫–∞: "Can't parse entities"

**–†–µ—à–µ–Ω–∏–µ:**
```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
await message.answer(
    f"<b>–†–µ–π—Å #{trip_number}</b>\n"
    f"üìû {phone}",  # –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ª—é–±—ã–µ —Å–∏–º–≤–æ–ª—ã
    parse_mode="HTML"
)

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
await message.answer(
    f"**–†–µ–π—Å #{trip_number}**\n"
    f"üìû {phone}",  # –û—à–∏–±–∫–∞ –µ—Å–ª–∏ phone = "+7_999_123_45_67"
    parse_mode="Markdown"
)
```

### 6. ‚ö†Ô∏è Callback Query vs Message

**–î–≤–∞ —Ç–∏–ø–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:**

```python
# Callback Query - –Ω–∞–∂–∞—Ç–∏–µ inline –∫–Ω–æ–ø–∫–∏
@router.callback_query(F.data == "list_trips")
async def handler(callback: CallbackQuery):
    # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await callback.message.edit_text("...")
    await callback.answer()  # –£–±—Ä–∞—Ç—å —á–∞—Å–∏–∫–∏

# Message - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –∫–Ω–æ–ø–∫–∏
@router.message(F.text == "üìã –ú–æ–π —Ä–µ–π—Å")
async def handler(message: Message):
    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await message.answer("...")
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:**
```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
@router.callback_query(F.data == "back")
async def back(callback: CallbackQuery):
    await callback.message.answer("...")  # –û—Ç–ø—Ä–∞–≤–∏—Ç –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ!

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
@router.callback_query(F.data == "back")
async def back(callback: CallbackQuery):
    await callback.message.edit_text("...")  # –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â–µ–µ
```

### 7. ‚ö†Ô∏è –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—ã

**–î–≤–∞ —Ç–∏–ø–∞ –≥—Ä—É–ø–ø:**

1. **GROUP_CHAT_ID** (–∏–∑ .env) - –æ—Å–Ω–æ–≤–Ω–∞—è –≥—Ä—É–ø–ø–∞ –∫—É—Ä–∞—Ç–æ—Ä–æ–≤
2. **–•–∞—Ä–¥–∫–æ–¥ –≤ –∫–æ–¥–µ:**
   - CURATOR_GROUP_ID = -1002606502231 (–ö—É—Ä–∞—Ç–æ—Ä –†–µ–π—Å–∞)
   - DOCUMENTS_GROUP_ID = -5054329274 (–ì–¥–µ–ì—Ä—É–∑ –î–æ–∫—É–º–µ–Ω—Ç—ã)

**–í–∞–∂–Ω–æ:**
- –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—ã
- –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π

### 8. ‚ö†Ô∏è –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

**–ö—É—Ä–∞—Ç–æ—Ä—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è:**

```bash
# .env
CURATOR_IDS=123456789,987654321
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
def is_curator(user_id: int) -> bool:
    return user_id in CURATOR_IDS
```

**–í–∞–∂–Ω–æ:** –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è .env –Ω—É–∂–µ–Ω –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫:
```bash
docker-compose restart bot
```

### 9. ‚ö†Ô∏è –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

**–†–∞–±–æ—Ç–∞–µ—Ç –≤ `bot/main.py`:**

```python
async def reminder_loop():
    """–ö–∞–∂–¥—ã–µ REMIND_HOURS –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π"""
    while True:
        # –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è
        # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É
        # –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ > REMIND_HOURS ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
        await asyncio.sleep(3600)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```bash
# .env
REMIND_HOURS=12  # –ù–∞–ø–æ–º–∏–Ω–∞—Ç—å –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤
```

### 10. ‚ö†Ô∏è –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

**–î–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8000:**
```
http://SERVER_IP:8000/
```

**–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- –ö–∞—Ä—Ç—É —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ —Ç–æ—á–∫–∞–º–∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π
- –†–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –±–æ—Ç–æ–º

**–í–∞–∂–Ω–æ:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ –ë–î (points.db)

---

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

**1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:**
```bash
git clone <repo_url> /home/git/fleet-live-bot
cd /home/git/fleet-live-bot
```

**2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```bash
cp .env.example .env
nano .env
```

–ó–∞–ø–æ–ª–Ω–∏—Ç—å:
```env
BOT_TOKEN=123456:ABC-DEF...
CURATOR_IDS=123456789,987654321
GROUP_CHAT_ID=-1001234567890
REMIND_HOURS=12
STAGE=bot
```

**3. –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫:**
```bash
docker-compose build --no-cache
docker-compose up -d
docker-compose logs -f bot
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞

**1. –°–∫–∞—á–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
```bash
cd /home/git/fleet-live-bot
git fetch origin <branch_name>
git checkout <branch_name>
git pull origin <branch_name>
```

**2. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫:**
```bash
docker-compose down
docker-compose build --no-cache bot
docker-compose up -d
docker-compose logs -f bot
```

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

**–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î:**

```bash
# –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä migrate_xxx.py)
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å

BOT_ID=$(/usr/bin/docker ps | grep fleet-live-bot-bot | awk '{print $1}')
/usr/bin/docker cp migrate_xxx.py $BOT_ID:/app/
/usr/bin/docker exec $BOT_ID python /app/migrate_xxx.py
```

**–ü—Ä–∏–º–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏:**
```python
import asyncio
import aiosqlite
from pathlib import Path

async def migrate():
    db_path = Path('/home/git/fleet-live-bot/userdata/points.db')
    async with aiosqlite.connect(db_path) as db:
        # –í–∞—à–∞ –º–∏–≥—Ä–∞—Ü–∏—è
        await db.execute("ALTER TABLE drivers ADD COLUMN new_field TEXT")
        await db.commit()

asyncio.run(migrate())
```

### –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ë–î –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤:**
```bash
/home/git/fleet-live-bot/userdata/
‚îú‚îÄ‚îÄ points.db      # –í–æ–¥–∏—Ç–µ–ª–∏ –∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è
‚îî‚îÄ‚îÄ trips.db       # –†–µ–π—Å—ã
```

**–°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞:**
```bash
cd /home/git/fleet-live-bot/userdata
tar -czf backup_$(date +%Y%m%d_%H%M%S).tar.gz *.db
```

### –õ–æ–≥–∏

**–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:**
```bash
# –í —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
docker-compose logs -f bot

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫
docker-compose logs --tail=100 bot

# –° –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
docker-compose logs --since 2h bot
```

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ

‚úÖ **–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ handlers
‚úÖ **FSM –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π** - —É–¥–æ–±–Ω–æ –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
‚úÖ **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ë–î** - –º–æ–∂–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ
‚úÖ **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤** - –Ω–∞–¥–µ–∂–Ω–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚úÖ **HTML parse mode** - –Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∞–º–∏

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

#### 1. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ PostgreSQL

**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** SQLite –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π concurrent access

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ó–∞–º–µ–Ω–∏—Ç—å aiosqlite –Ω–∞ asyncpg
import asyncpg

async def get_connection():
    return await asyncpg.connect(
        host='localhost',
        database='gdegruz',
        user='postgres',
        password='...'
    )
```

**–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ:** –ü—Ä–∏ >100 –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª—è—Ö

#### 2. Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

**–î–ª—è —á–µ–≥–æ:**
- –ö—ç—à –∏–º–µ–Ω –≤–æ–¥–∏—Ç–µ–ª–µ–π (—Ñ—É–Ω–∫—Ü–∏—è `get_driver_name_by_phone`)
- –ö—ç—à –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç–æ—á–µ–∫
- –•—Ä–∞–Ω–µ–Ω–∏–µ FSM states

**–ü—Ä–∏–º–µ—Ä:**
```python
import aioredis

redis = await aioredis.create_redis_pool('redis://localhost')

# –ö—ç—à –∏–º–µ–Ω–∏ –Ω–∞ 1 —á–∞—Å
await redis.setex(f"driver_name:{phone}", 3600, driver_name)
```

#### 3. Celery –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –≤ —Ç–æ–º –∂–µ –ø—Ä–æ—Ü–µ—Å—Å–µ

**–†–µ—à–µ–Ω–∏–µ:**
```python
from celery import Celery

app = Celery('gdegruz', broker='redis://localhost')

@app.task
def send_reminder(user_id):
    # –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    pass

# –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤
app.conf.beat_schedule = {
    'send-reminders': {
        'task': 'send_reminder',
        'schedule': crontab(hour='*/12'),
    },
}
```

#### 4. Webhook –≤–º–µ—Å—Ç–æ Polling

**–¢–µ–∫—É—â–∏–π –º–µ—Ç–æ–¥:** Long Polling (dp.start_polling)

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:**
```python
# main.py
from aiogram.webhook.aiohttp_server import SimpleRequestHandler, setup_application
from aiohttp import web

async def on_startup(bot: Bot):
    await bot.set_webhook(f"https://your-domain.com/webhook")

app = web.Application()
webhook_requests_handler = SimpleRequestHandler(
    dispatcher=dp,
    bot=bot,
)
webhook_requests_handler.register(app, path="/webhook")
setup_application(app, dp, bot=bot)
web.run_app(app, host="0.0.0.0", port=8443)
```

**–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ:** –ü—Ä–∏ –±–æ–ª—å—à–∏—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö

#### 5. –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**Prometheus + Grafana:**

```python
from prometheus_client import Counter, Histogram, start_http_server

trips_created = Counter('trips_created_total', 'Total trips created')
location_updates = Counter('location_updates_total', 'Location updates')
response_time = Histogram('handler_response_time', 'Handler response time')

# –í –∫–æ–¥–µ
trips_created.inc()
location_updates.inc()

# –ú–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ :9090/metrics
start_http_server(9090)
```

#### 6. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥:**

1. **–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π handler:**
```python
# bot/handlers/documents.py
from aiogram import Router, F
from aiogram.types import Message

router = Router()

@router.message(F.text == "üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã")
async def documents_menu(message: Message):
    # –í–∞—à–∞ –ª–æ–≥–∏–∫–∞
    pass
```

2. **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ main.py:**
```python
from bot.handlers import documents

dp.include_router(documents.router)
```

3. **–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ë–î - –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤ db.py –∏–ª–∏ db_trips.py:**
```python
# db.py
async def get_driver_documents(user_id: int):
    async with aiosqlite.connect(DB_PATH) as db:
        # ...
        pass
```

4. **–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ - —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:**
```python
# migrate_add_documents.py
async def migrate():
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute("""
            CREATE TABLE IF NOT EXISTS documents (
                id INTEGER PRIMARY KEY,
                user_id INTEGER,
                file_id TEXT,
                created_at TEXT
            )
        """)
        await db.commit()
```

#### 7. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ API

**–ü—Ä–∏–º–µ—Ä—ã:**

- **–ú–∞—Ä—à—Ä—É—Ç—ã:** Google Maps API / Yandex Maps API
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:** SMS —á–µ—Ä–µ–∑ Twilio / Email —á–µ—Ä–µ–∑ SendGrid
- **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞:** Google Analytics / Amplitude

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```python
# services/maps.py
import httpx

async def get_route(origin, destination):
    async with httpx.AsyncClient() as client:
        response = await client.get(
            'https://maps.googleapis.com/maps/api/directions/json',
            params={'origin': origin, 'destination': destination}
        )
        return response.json()

# –í handler
from services.maps import get_route

route = await get_route(loading_address, unloading_address)
```

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∫–æ–¥–∞

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ–π—Å–∞

```python
# 1. –í db_trips.py - –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, status - —ç—Ç–æ TEXT

# 2. –í curator.py - –¥–æ–±–∞–≤–∏—Ç—å –≤ –º–∞–ø–ø–∏–Ω–≥
status_map = {
    'assigned': '‚è≥ –û–∂–∏–¥–∞–µ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏',
    'new_status': 'üÜï –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å',  # ‚Üê –î–æ–±–∞–≤–∏—Ç—å
}

# 3. –í driver_trips.py - –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥
if trip['status'] == 'in_transit':
    kb.button(text="üÜï –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å",
              callback_data=f"set_status:{trip_id}:new_status")
```

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```python
async def send_notification(user_id, text):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
    try:
        await bot.send_message(user_id, text, parse_mode="HTML")
        logger.info(f"Notification sent to {user_id}")
    except TelegramBadRequest as e:
        if "blocked by the user" in str(e):
            logger.warning(f"User {user_id} blocked bot")
        else:
            logger.error(f"Failed to send to {user_id}: {e}")
    except Exception as e:
        logger.error(f"Unexpected error sending to {user_id}: {e}")
```

#### –†–∞–±–æ—Ç–∞ —Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π

```python
from db import save_point, get_last_point

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ—á–∫–∏
await save_point(
    user_id=message.from_user.id,
    lat=message.location.latitude,
    lon=message.location.longitude
)

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–∏
last_point = await get_last_point(user_id)
if last_point:
    # last_point = {'lat': 55.7558, 'lon': 37.6173, 'ts': '2025-11-06T12:00:00'}
    pass
```

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "–ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# 1. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω?
docker-compose ps

# 2. –õ–æ–≥–∏
docker-compose logs --tail=50 bot

# 3. –¢–æ–∫–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π?
grep BOT_TOKEN .env
```

### –ü—Ä–æ–±–ª–µ–º–∞: "–í–æ–¥–∏—Ç–µ–ª—å –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–æ–º–µ—Ä–∞ –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
BOT_ID=$(/usr/bin/docker ps | grep fleet-live-bot-bot | awk '{print $1}')
/usr/bin/docker exec $BOT_ID python /app/migrate_normalize_phones.py
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Parse entities error"

**–ü—Ä–∏—á–∏–Ω–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è Markdown –≤–º–µ—Å—Ç–æ HTML

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `parse_mode="Markdown"` –Ω–∞ `parse_mode="HTML"`

```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ –º–µ—Å—Ç–∞
grep -r 'parse_mode="Markdown"' bot/handlers/
```

### –ü—Ä–æ–±–ª–µ–º–∞: "No space left on device"

**–ü—Ä–∏—á–∏–Ω–∞:** –î–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –û—á–∏—Å—Ç–∫–∞ Docker
/usr/bin/docker system prune -a -f --volumes

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
journalctl --vacuum-size=100M

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Å—Ç–∞
df -h
```

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

**–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞:** Claude (Anthropic AI)
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ö–æ–º–∞–Ω–¥–∞ –¢–µ—Ö–Ω–æ–õ–æ–≥–∏—Å—Ç–∏–∫–∞
**–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:** Git (–≤–µ—Ç–∫–∞ claude/simplify-trips-system-phase-2-1-...)

---

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### Version 2.0 (–ù–æ—è–±—Ä—å 2025)

- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–π—Å–æ–≤ (–±–µ–∑ –≤–∞–≥–æ–Ω–æ–≤)
- ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –≤–æ–¥–∏—Ç–µ–ª—è –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö —Ä–µ–π—Å–æ–≤
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ 2 –≥—Ä—É–ø–ø—ã –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
- ‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–π—Å–æ–≤
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤–æ–¥–∏—Ç–µ–ª–µ–º
- ‚úÖ FSM –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–π—Å–æ–≤
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ HTML parse mode

### Version 1.0 (2024)

- –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
- –°–∏—Å—Ç–µ–º–∞ —Å –≤–∞–≥–æ–Ω–∞–º–∏ (—É–¥–∞–ª–µ–Ω–∞ –≤ v2.0)

---

**–î–æ–∫—É–º–µ–Ω—Ç —Å–æ—Å—Ç–∞–≤–ª–µ–Ω:** 06.11.2025
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 06.11.2025
**–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å:** Production Ready
