name: Auto-create PR for Claude branches

on:
  push:
    branches:
      - 'claude/**'

# ÐÐµ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð½Ð° pull_request events
# (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° push Ð² Ð²ÐµÑ‚ÐºÐ¸ claude/*)

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Get branch name
      id: branch
      run: |
        BRANCH_NAME="${GITHUB_REF#refs/heads/}"
        echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "ðŸ“ Current branch: $BRANCH_NAME"

    - name: Check if PR exists
      id: check_pr
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_NUMBER=$(gh pr list --head "${{ steps.branch.outputs.name }}" --base main --json number --jq '.[0].number // empty')

        if [ -n "$PR_NUMBER" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          PR_URL=$(gh pr view "$PR_NUMBER" --json url --jq '.url')
          echo "url=$PR_URL" >> $GITHUB_OUTPUT
          echo "âœ… PR #$PR_NUMBER ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚: $PR_URL"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ PR Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð½Ð¾Ð²Ñ‹Ð¹"
        fi

    - name: Create Pull Request
      if: steps.check_pr.outputs.exists == 'false'
      id: create_pr
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚ Ð´Ð»Ñ title
        COMMIT_MSG=$(git log -1 --pretty=%B | head -1)

        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ PR
        PR_URL=$(gh pr create \
          --base main \
          --head "${{ steps.branch.outputs.name }}" \
          --title "ðŸ¤– ${COMMIT_MSG}" \
          --body "## ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ñ‡ÐµÑ€ÐµÐ· Claude Code

**Ð’ÐµÑ‚ÐºÐ°:** \`${{ steps.branch.outputs.name }}\`

### Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ:

\`\`\`
$(git log -1 --pretty=%B)
\`\`\`

---

### ðŸ‘‰ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ ÑˆÐ°Ð³:
ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ **\"Merge pull request\"** Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð´ÐµÐ¿Ð»Ð¾Ð¸Ñ‚ÑŒ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€

ÐŸÐ¾ÑÐ»Ðµ merge Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸:
- âœ… Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° Timeweb ÑÐµÑ€Ð²ÐµÑ€
- âœ… Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð¿ÐµÑ€ÐµÑÐ¾Ð±ÐµÑ€ÑƒÑ‚ÑÑ
- âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑÑ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ñ„Ð»Ð°Ð³ .cleanup_db_on_deploy)
- âœ… Ð‘Ð¾Ñ‚ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ Ñ Ð½Ð¾Ð²Ñ‹Ð¼ ÐºÐ¾Ð´Ð¾Ð¼
")

        echo "url=$PR_URL" >> $GITHUB_OUTPUT
        echo "âœ… PR ÑÐ¾Ð·Ð´Ð°Ð½: $PR_URL"

    - name: Summary
      run: |
        if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
          echo "## â„¹ï¸ Pull Request ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **PR URL:** ${{ steps.check_pr.outputs.url }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âœ… Pull Request ÑÐ¾Ð·Ð´Ð°Ð½!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **PR URL:** ${{ steps.create_pr.outputs.url }}" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ‘‰ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ ÑˆÐ°Ð³:" >> $GITHUB_STEP_SUMMARY
        echo "1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ PR Ð¿Ð¾ ÑÑÑ‹Ð»ÐºÐµ Ð²Ñ‹ÑˆÐµ" >> $GITHUB_STEP_SUMMARY
        echo "2. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð·ÐµÐ»ÐµÐ½ÑƒÑŽ ÐºÐ½Ð¾Ð¿ÐºÑƒ **\"Merge pull request\"**" >> $GITHUB_STEP_SUMMARY
        echo "3. ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ðµ Ð½Ð°Ð¶Ð°Ð² **\"Confirm merge\"**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Ð§Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð¸Ð·Ð¾Ð¹Ð´ÐµÑ‚ Ð¿Ð¾ÑÐ»Ðµ merge:" >> $GITHUB_STEP_SUMMARY
        echo "- GitHub Actions Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ð¹" >> $GITHUB_STEP_SUMMARY
        echo "- ÐšÐ¾Ð´ Ð·Ð°Ð´ÐµÐ¿Ð»Ð¾Ð¸Ñ‚ÑÑ Ð½Ð° Timeweb ÑÐµÑ€Ð²ÐµÑ€" >> $GITHUB_STEP_SUMMARY
        echo "- Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð¿ÐµÑ€ÐµÑÐ¾Ð±ÐµÑ€ÑƒÑ‚ÑÑ" >> $GITHUB_STEP_SUMMARY
        echo "- Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑÑ Ð¾Ñ‚ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…" >> $GITHUB_STEP_SUMMARY
        echo "- Ð‘Ð¾Ñ‚ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ Ñ Ð½Ð¾Ð²Ñ‹Ð¼ ÐºÐ¾Ð´Ð¾Ð¼" >> $GITHUB_STEP_SUMMARY
