name: Auto-merge Claude branches

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"

    - name: Get branch name
      id: branch
      run: |
        BRANCH_NAME="${GITHUB_REF#refs/heads/}"
        echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "ðŸ“ Current branch: $BRANCH_NAME"

    - name: Check if PR exists
      id: check_pr
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ PR Ð´Ð»Ñ ÑÑ‚Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸
        PR_NUMBER=$(gh pr list --head "${{ steps.branch.outputs.name }}" --json number --jq '.[0].number')

        if [ -n "$PR_NUMBER" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ… PR #$PR_NUMBER ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ PR Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð½Ð¾Ð²Ñ‹Ð¹"
        fi

    - name: Create Pull Request
      if: steps.check_pr.outputs.exists == 'false'
      id: create_pr
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚ Ð´Ð»Ñ title
        COMMIT_MSG=$(git log -1 --pretty=%B)

        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ PR
        PR_URL=$(gh pr create \
          --base main \
          --head "${{ steps.branch.outputs.name }}" \
          --title "ðŸ¤– Auto-deploy: ${COMMIT_MSG:0:60}" \
          --body "## ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ñ‡ÐµÑ€ÐµÐ· Claude Code

        **Ð’ÐµÑ‚ÐºÐ°:** \`${{ steps.branch.outputs.name }}\`
        **ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹:** $(git rev-list --count origin/main..${{ steps.branch.outputs.name }})

        ### Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ:

        \`\`\`
        $COMMIT_MSG
        \`\`\`

        ---

        âœ… Ð­Ñ‚Ð¾Ñ‚ PR Ð±ÑƒÐ´ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¼ÐµÑ€Ð¶ÐµÐ½ Ð² \`main\` Ð¸ Ð·Ð°Ð´ÐµÐ¿Ð»Ð¾ÐµÐ½ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€.
        " \
          --assignee @me)

        echo "url=$PR_URL" >> $GITHUB_OUTPUT
        echo "âœ… PR ÑÐ¾Ð·Ð´Ð°Ð½: $PR_URL"

    - name: Merge Pull Request
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð½Ð¾Ð¼ÐµÑ€ PR
        if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
          PR_NUMBER="${{ steps.check_pr.outputs.number }}"
        else
          # Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ñ‡Ñ‚Ð¾Ð±Ñ‹ PR Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð»ÑÑ
          sleep 5
          PR_NUMBER=$(gh pr list --head "${{ steps.branch.outputs.name }}" --json number --jq '.[0].number')
        fi

        echo "ðŸ”„ ÐœÐµÑ€Ð¶Ð¸Ð¼ PR #$PR_NUMBER Ð² main..."

        # ÐœÐµÑ€Ð¶Ð¸Ð¼ PR
        gh pr merge "$PR_NUMBER" \
          --merge \
          --auto \
          --delete-branch \
          || echo "âš ï¸ PR ÑƒÐ¶Ðµ ÑÐ¼ÐµÑ€Ð¶ÐµÐ½ Ð¸Ð»Ð¸ ÐµÑÑ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ñ‹"

        echo "âœ… PR #$PR_NUMBER ÑÐ¼ÐµÑ€Ð¶ÐµÐ½ Ð² main"
        echo "ðŸš€ GitHub Actions Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€..."

    - name: Summary
      run: |
        echo "## ðŸŽ‰ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Ð’ÐµÑ‚ÐºÐ° \`${{ steps.branch.outputs.name }}\` ÑÐ¼ÐµÑ€Ð¶ÐµÐ½Ð° Ð² \`main\`" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ Ð½Ð°Ñ‡Ð½ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ñ‡ÐµÑ€ÐµÐ· Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÐµÐºÑƒÐ½Ð´" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Ð§Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð¸Ð·Ð¾Ð¹Ð´ÐµÑ‚ Ð´Ð°Ð»ÑŒÑˆÐµ:" >> $GITHUB_STEP_SUMMARY
        echo "1. GitHub Actions Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ workflow \`Auto Deploy Bot\`" >> $GITHUB_STEP_SUMMARY
        echo "2. ÐšÐ¾Ð´ Ð±ÑƒÐ´ÐµÑ‚ Ð·Ð°Ð´ÐµÐ¿Ð»Ð¾ÐµÐ½ Ð½Ð° Timeweb ÑÐµÑ€Ð²ÐµÑ€" >> $GITHUB_STEP_SUMMARY
        echo "3. Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð¿ÐµÑ€ÐµÑÐ¾Ð±ÐµÑ€ÑƒÑ‚ÑÑ" >> $GITHUB_STEP_SUMMARY
        echo "4. Ð‘Ð¾Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ" >> $GITHUB_STEP_SUMMARY
