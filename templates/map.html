<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Map - Driver {{ user_id }}</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+4tHooJKALNSnG3xv7tOjYoyLh6HB0eItnACznrs8="
    crossorigin=""
  />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    }
    #header {
      background: #2c3e50;
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 500;
    }
    #status {
      margin: 5px 0 0 0;
      font-size: 13px;
      opacity: 0.8;
    }
    #map {
      height: calc(100vh - 80px);
      width: 100%;
    }
    .error-message {
      position: absolute;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: #e74c3c;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>
<div id="header">
  <h1>üöö –í–æ–¥–∏—Ç–µ–ª—å {{ user_id }}</h1>
  <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div id="error" class="error-message"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-oQmLsCkvwKZZpt0kH+uLHOR2E31x4nHTqPtxypXQ1KA="
        crossorigin=""></script>
<script>
  const userId = {{ user_id }};
  // –í–ê–ñ–ù–û: –¢–æ–∫–µ–Ω –ù–ï –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ JavaScript!
  // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ HttpOnly cookie

  const map = L.map('map').setView([55.7558, 37.6173], 5); // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  let marker = null;
  let lastUpdate = null;

  function showError(message) {
    const errorDiv = document.getElementById('error');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
      errorDiv.style.display = 'none';
    }, 5000);
  }

  function updateStatus(text, isError = false) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = text;
    statusDiv.style.color = isError ? '#e74c3c' : 'rgba(255,255,255,0.8)';
  }

  function formatTimeDiff(date) {
    const now = new Date();
    const diff = Math.floor((now - date) / 1000); // —Å–µ–∫—É–Ω–¥—ã

    if (diff < 60) return `${diff} —Å–µ–∫. –Ω–∞–∑–∞–¥`;
    if (diff < 3600) return `${Math.floor(diff / 60)} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
    if (diff < 86400) return `${Math.floor(diff / 3600)} —á. –Ω–∞–∑–∞–¥`;
    return `${Math.floor(diff / 86400)} –¥–Ω. –Ω–∞–∑–∞–¥`;
  }

  async function refresh() {
    try {
      // Cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º!
      // –ù–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
      const resp = await fetch(`/api/last/${userId}`, {
        credentials: 'include'  // –í–∞–∂–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ cookies
      });

      if (!resp.ok) {
        if (resp.status === 401 || resp.status === 403) {
          showError('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
          updateStatus('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞', true);
        } else if (resp.status === 404) {
          updateStatus('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏', true);
        } else {
          throw new Error(`HTTP ${resp.status}`);
        }
        return;
      }

      const data = await resp.json();
      const lat = data.lat;
      const lon = data.lon;
      const ts = new Date(data.ts);

      lastUpdate = ts;

      // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
      if (!marker) {
        marker = L.marker([lat, lon]).addTo(map);
        marker.bindPopup(`–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${ts.toLocaleString('ru-RU')}`);
        map.setView([lat, lon], 13);
      } else {
        marker.setLatLng([lat, lon]);
        marker.getPopup().setContent(`–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${ts.toLocaleString('ru-RU')}`);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
      updateStatus(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${formatTimeDiff(ts)}`);

    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
      updateStatus(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è`, true);
      showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ${e.message}`);
    }
  }

  // –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
  refresh();

  // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
  setInterval(refresh, 10000);

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
  setInterval(() => {
    if (lastUpdate) {
      updateStatus(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${formatTimeDiff(lastUpdate)}`);
    }
  }, 1000);
</script>
</body>
</html>
